---
last_sync: 2025-09-10T04:07:26Z
name: 数据存储和CSV导出
status: open
created: 2025-09-09T04:10:01Z
updated: 2025-09-09T04:10:01Z
github: [Will be updated when synced to GitHub]
depends_on: [006]
parallel: true
conflicts_with: []
---

# Task: 数据存储和CSV导出

## Description

实现采集数据的CSV格式导出功能，支持时间戳、地址信息和数据值的结构化存储，提供灵活的导出选项和文件管理功能。

## Acceptance Criteria

- [ ] 创建DataExporter组件，提供CSV导出界面
- [ ] 实现CSV文件格式化，包含时间戳、地址、原始值、解析值列
- [ ] 支持导出时间范围选择和数据过滤
- [ ] 添加导出文件命名规则（时间戳+设备信息）
- [ ] 实现大数据量的分批导出，避免内存溢出
- [ ] 支持导出进度显示和取消操作
- [ ] 添加导出文件的预览和验证功能

## Technical Details

### 实现方案

1. **CSV格式定义**:
   ```csv
   Timestamp,Address,Range_Name,Raw_Value,Parsed_Value,Data_Type,Unit,Status
   2025-09-09T12:30:45.123Z,1000,Temperature,12345,23.45,float32,°C,OK
   2025-09-09T12:30:45.123Z,1002,Pressure,45678,456.78,float32,kPa,OK
   2025-09-09T12:30:45.123Z,2000,Flow,ERROR,N/A,uint16,L/min,TIMEOUT
   ```

2. **组件结构**:
   ```tsx
   // src/components/DataExporter.tsx
   interface ExportConfig {
     timeRange: { start: Date; end: Date };
     addressFilter?: number[];
     includeErrors: boolean;
     fileFormat: 'csv' | 'json';
     batchSize: number;
   }
   
   export function DataExporter() {
     // 导出配置、进度显示、文件管理
   }
   ```

3. **后端CSV写入器**:
   ```rust
   // src-tauri/src/storage/csv_writer.rs
   pub struct CsvWriter {
       file_path: PathBuf,
       writer: csv::Writer<File>,
       batch_size: usize,
   }
   
   impl CsvWriter {
       pub fn new(file_path: PathBuf) -> Result<Self>;
       pub async fn write_batch(&mut self, data: &[DataSample]) -> Result<()>;
       pub fn finalize(self) -> Result<CsvExportResult>;
   }
   ```

4. **Tauri导出命令**:
   ```rust
   #[tauri::command]
   async fn export_to_csv(
       config: ExportConfig,
       file_path: String
   ) -> Result<ExportResult, String>
   
   #[tauri::command]
   async fn get_export_progress() -> Result<ExportProgress, String>
   ```

5. **界面设计**:
   ```
   ┌─────────────────────────────────────────────────────┐
   │ 数据导出                                             │
   ├─────────────────────────────────────────────────────┤
   │ 时间范围: [2025-09-09 10:00] 至 [2025-09-09 12:00]  │
   │ 地址过滤: [全部▼] 包含错误: ☑️                      │
   │ 文件名:   modbus_data_20250909_120000.csv          │
   │                                                     │
   │ [选择保存位置] [预览数据] [开始导出]                 │
   │                                                     │
   │ ┌─导出进度─────────────────────────────────────────┐ │
   │ │ ████████████████████░░░░░░░░ 65% (1,300/2,000)  │ │
   │ │ 正在处理: 2025-09-09T11:30:00 数据              │ │
   │ │ 预计剩余: 45秒                                   │ │
   │ │ [取消导出]                                       │ │
   │ └─────────────────────────────────────────────────┘ │
   │                                                     │
   │ 📁 导出历史:                                         │
   │ • modbus_data_20250909_100000.csv (2.5MB)          │
   │ • modbus_data_20250908_140000.csv (1.8MB)          │
   └─────────────────────────────────────────────────────┘
   ```

### 核心功能
- **格式化输出**: 标准化CSV格式，便于Excel等工具处理
- **大文件处理**: 流式写入，支持GB级数据导出
- **数据验证**: 导出完成后验证文件完整性
- **历史管理**: 导出文件历史记录和快速访问

### 性能优化
- 异步文件I/O，不阻塞界面
- 内存流式处理，避免大数据加载
- 压缩选项，减少文件大小

## Dependencies

- [ ] 任务006（批量数据采集）- 采集数据可用
- [ ] CSV处理库（csv crate for Rust）
- [ ] 文件对话框组件（Tauri文件API）

## Effort Estimate

- Size: L
- Hours: 16-20小时
- Parallel: true（可与其他UI功能并行）

## Definition of Done

- [ ] 用户可以选择时间范围导出采集数据
- [ ] 导出的CSV文件格式正确，可被Excel正常打开
- [ ] 大数据量导出过程稳定，进度信息准确
- [ ] 导出过程可以取消，不会产生不完整文件
- [ ] 导出文件包含完整的时间戳和数据信息
- [ ] 文件命名规则清晰，便于数据管理
- [ ] 导出性能满足需求（1万条记录<30秒）