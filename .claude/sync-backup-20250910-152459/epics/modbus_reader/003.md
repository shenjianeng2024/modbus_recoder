---
last_sync: 2025-09-10T04:07:26Z
name: Modbus核心功能实现
status: open
created: 2025-09-09T04:10:01Z
updated: 2025-09-09T04:10:01Z
github: [Will be updated when synced to GitHub]
depends_on: [001]
parallel: false
conflicts_with: []
---

# Task: Modbus核心功能实现

## Description

实现Modbus TCP/IP客户端的核心功能，包括连接管理、数据读取和基础错误处理。集成tokio-modbus库，建立Rust后端与Modbus设备通信的基础架构。

## Acceptance Criteria

- [ ] 集成tokio-modbus依赖到Cargo.toml
- [ ] 实现ModbusClient结构体，支持TCP连接管理
- [ ] 实现read_holding_registers方法，支持连续地址读取
- [ ] 实现连接状态管理（Connected/Disconnected/Connecting）
- [ ] 实现基础错误处理和错误类型定义
- [ ] 创建Tauri命令接口，前端可调用Modbus功能
- [ ] 编写单元测试验证核心读取功能

## Technical Details

### 实现方案

1. **依赖配置**:
   ```toml
   # Cargo.toml
   [dependencies]
   tokio-modbus = "0.12"
   tokio = { version = "1.0", features = ["full"] }
   serde = { version = "1.0", features = ["derive"] }
   thiserror = "1.0"
   ```

2. **核心模块结构**:
   ```rust
   // src-tauri/src/modbus/
   ├── mod.rs           # 模块导出
   ├── client.rs        # Modbus客户端实现
   ├── types.rs         # 数据类型定义
   └── error.rs         # 错误处理
   ```

3. **关键实现**:
   ```rust
   // ModbusClient 核心结构
   pub struct ModbusClient {
       context: Option<Context>,
       socket_addr: String,
       connection_state: ConnectionState,
   }
   
   // 核心方法
   impl ModbusClient {
       pub async fn connect(&mut self, ip: &str, port: u16) -> Result<()>
       pub async fn disconnect(&mut self) -> Result<()>
       pub async fn read_registers(&mut self, start: u16, count: u16) -> Result<Vec<u16>>
       pub fn is_connected(&self) -> bool
   }
   ```

4. **Tauri命令接口**:
   ```rust
   #[tauri::command]
   async fn modbus_connect(ip: String, port: u16) -> Result<String, String>
   
   #[tauri::command]
   async fn modbus_read_registers(start: u16, count: u16) -> Result<Vec<u16>, String>
   
   #[tauri::command]
   async fn modbus_disconnect() -> Result<String, String>
   ```

### 核心文件
- `src-tauri/src/modbus/client.rs`: 主要的Modbus客户端实现
- `src-tauri/src/modbus/types.rs`: 数据结构和类型定义
- `src-tauri/src/modbus/error.rs`: 错误类型和处理
- `src-tauri/src/commands/mod.rs`: Tauri命令注册

## Dependencies

- [ ] 任务001（项目初始化）必须完成
- [ ] tokio-modbus库API文档研究
- [ ] Modbus TCP/IP协议基础知识

## Effort Estimate

- Size: L
- Hours: 16-20小时
- Parallel: false（依赖项目初始化）

## Definition of Done

- [ ] tokio-modbus集成成功，编译无错误
- [ ] 可以成功连接到Modbus TCP设备（或模拟器）
- [ ] 可以读取holding registers并返回正确数据
- [ ] 错误情况（网络中断、超时、设备无响应）能正确处理
- [ ] Tauri命令接口工作正常，前端可以调用
- [ ] 单元测试覆盖率>80%，主要功能测试通过
- [ ] 连接状态变化正确通知前端